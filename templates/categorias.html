{% extends 'bootstrap/base.html' %}
{% block head %}
    {{ super() }}
    {% block title %}Diconsa Web App - Categorías{% endblock %}
    <link rel="stylesheet" href="../static/style.css">
    <style>
        .btn-group-sm > .btn, .btn-sm {
            margin: 0 2px;
        }
        .table td {
            vertical-align: middle;
        }
    </style>
{% endblock %}

{% block body %}
    {% block navbar %}
        {% include 'navbar.html' %}
    {% endblock %}

    {% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Gestión de Categorías</h2>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Barra de búsqueda -->
        <div class="row mb-3">
            <div class="col-md-6">
                <form action="{{ url_for('buscar_categorias') }}" method="POST" class="form-inline">
                    <div class="input-group w-100">
                        <input type="text" name="buscar" class="form-control" placeholder="Buscar por nombre o ID...">
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-6 text-right">
                <a href="{{ url_for('registrar_categoria') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Nueva Categoría
                </a>
            </div>
        </div>

        <!-- Tabla de categorías -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for categoria in datos %}
                    <tr>
                        <td>{{ categoria[0] }}</td>
                        <td>{{ categoria[1] }}</td>
                        <td class="text-center">
                            <form action="{{ url_for('update1_categoria', id_categ=categoria[0]) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </form>
                            <button type="button" class="btn btn-delete btn-sm" onclick="showModal('{{ url_for('eliminar_categoria', id_categ=categoria[0]) }}')">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Modal para confirmación de eliminación -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <div class="modal-body">
                    <h2>Confirmación</h2>
                    <p>¿Estás seguro de que deseas eliminar esta categoría?</p>
                </div>
                <div class="modal-footer">
                    <form id="deleteForm" method="POST" action="" onsubmit="return submitForm()">
                        <button type="submit" class="btn btn-danger">Confirmar</button>
                    </form>
                    <button class="cancel-btn" onclick="closeModal()">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        var currentDeleteUrl = '';

        // Mostrar modal y establecer la URL para la eliminación
        function showModal(deleteUrl) {
            currentDeleteUrl = deleteUrl;
            document.getElementById('deleteForm').action = deleteUrl;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        // Enviar formulario de eliminación y redirigir después
        function submitForm() {
            window.location.href = '{{ url_for("categorias") }}';
            return true;  // Permite que el formulario se envíe
        }
    </script>

    {% endblock %}

{% endblock %}